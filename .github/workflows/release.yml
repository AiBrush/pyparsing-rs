name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

# Serialize releases so two quick merges get sequential versions
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  # ── Derive next version from latest git tag ──────────────────────
  calculate-version:
    name: Calculate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.version }}
      tag: ${{ steps.calc.outputs.tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Calculate next version
        id: calc
        run: |
          # Get the latest version tag
          latest=$(git tag -l 'v*' --sort=-v:refname | head -1)
          if [[ -z "$latest" ]]; then
            latest="v0.0.0"
          fi
          echo "Latest tag: $latest"

          # Parse version components
          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"

          # Determine bump type
          bump="${{ inputs.bump_type || 'patch' }}"
          echo "Bump type: $bump"

          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="${major}.${minor}.${patch}"
          new_tag="v${new_version}"
          echo "New version: $new_version (tag: $new_tag)"

          # Fail if tag already exists (shouldn't happen, but guard against it)
          if git rev-parse "$new_tag" >/dev/null 2>&1; then
            echo "::error::Tag $new_tag already exists!"
            exit 1
          fi

          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "tag=$new_tag" >> "$GITHUB_OUTPUT"

  # ── Python wheels: Linux (manylinux) ─────────────────────────────
  build-linux:
    name: Build (Linux ${{ matrix.target }})
    needs: [calculate-version]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, x86, aarch64, armv7, s390x, ppc64le]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Set version
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' pyproject.toml
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i 3.9 3.10 3.11 3.12 3.13
          sccache: true
          manylinux: auto
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist

  # ── Python wheels: Linux (musllinux) ─────────────────────────────
  build-musllinux:
    name: Build (musllinux ${{ matrix.target }})
    needs: [calculate-version]
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, x86, aarch64, armv7]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Set version
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' pyproject.toml
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i 3.9 3.10 3.11 3.12 3.13
          sccache: true
          manylinux: musllinux_1_2
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-musllinux-${{ matrix.target }}
          path: dist

  # ── Python wheels: macOS ─────────────────────────────────────────
  build-macos:
    name: Build (macOS ${{ matrix.target }})
    needs: [calculate-version]
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Set version
        run: |
          sed -i '' 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          sed -i '' 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' pyproject.toml
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i 3.9 3.10 3.11 3.12 3.13
          sccache: true
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-macos-${{ matrix.target }}
          path: dist

  # ── Python wheels: Windows ───────────────────────────────────────
  build-windows:
    name: Build (Windows ${{ matrix.target }})
    needs: [calculate-version]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: windows-latest
            target: x64
            python_arch: x64
          - runner: windows-latest
            target: x86
            python_arch: x86
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: |
            3.9
            3.10
            3.11
            3.12
            3.13
          architecture: ${{ matrix.python_arch }}
      - name: Set version
        shell: bash
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' pyproject.toml
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist -i 3.9 3.10 3.11 3.12 3.13
          sccache: true
      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-windows-${{ matrix.target }}
          path: dist

  # ── Source distribution ──────────────────────────────────────────
  build-sdist:
    name: Build (sdist)
    needs: [calculate-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set version
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' pyproject.toml
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: wheels-sdist
          path: dist

  # ── Publish: tag, PyPI, GitHub Release ─────────────────────────
  publish:
    name: Publish
    needs: [calculate-version, build-linux, build-musllinux, build-macos, build-windows, build-sdist]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
          pattern: wheels-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Create and push tag
        run: |
          git tag "${{ needs.calculate-version.outputs.tag }}"
          git push origin "${{ needs.calculate-version.outputs.tag }}"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Publish to PyPI
        continue-on-error: true
        run: uv publish dist/*
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/*'

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.calculate-version.outputs.tag }}" dist/* \
            --title "${{ needs.calculate-version.outputs.tag }}" \
            --generate-notes
